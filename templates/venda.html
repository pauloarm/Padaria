{% extends "base.html" %}
{% block title %}Nova Venda{% endblock %}
{% block content %}
<h3>Iniciar Venda</h3>

<form method="POST">
    <div class="row mb-3">
        <div class="col-md-4">
            <select name="item_id" class="form-select" required>
                {% for item in itens %}
                    <option value="{{ item[0] }}">{{ item[1] }} (R$ {{ "%.2f"|format(item[5]) }}) - {{ item[2] }} unid.</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" name="qtd" class="form-control" placeholder="Quantidade" min="1" required>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Adicionar</button>
        </div>
        <div class="col-md-2">
            <button type="submit" name="limpar" value="1" class="btn btn-danger w-100">Limpar Carrinho</button>
        </div>
    </div>
</form>

<!-- Carrinho -->
{% if carrinho %}
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Item</th>
                <th>Quantidade</th>
                <th>Valor Unitário</th>
                <th>Total</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in carrinho %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.quantidade }}</td>
                    <td>R$ {{ "%.2f"|format((item.valor / item.quantidade)) }}</td>
                    <td>R$ {{ "%.2f"|format(item.valor) }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('remover_item_carrinho') }}">
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                            <button type="submit" class="btn btn-danger btn-sm">Remover</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            <tr>
                <td colspan="3" class="text-end"><strong>Total da Venda:</strong></td>
                <td><strong>R$ {{ "%.2f"|format(total) }}</strong></td>
            </tr>
        </tbody>
    </table>

    <!-- Botão de Cancelar venda -->
    <form method="POST" action="{{ url_for('cancelar_venda') }}">
        <button type="submit" class="btn btn-outline-danger mb-3">Cancelar Venda</button>
    </form>

    <!-- Formulário de Finalização -->
    <form method="POST" action="{{ url_for('finalizar_venda') }}" id="formFinalizar">
        <div class="row">
            <!-- Forma de Pagamento -->
            <div class="col-md-4 mb-3">
                <select name="pagamento" id="pagamentoSelect" class="form-select" required>
                    <option value="">Forma de Pagamento</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="cartao">Cartão</option>
                    <option value="fiado">Fiado</option>
                </select>
            </div>

            <!-- Campo Cliente (apenas se for fiado) -->
            <div class="col-md-4 mb-3" id="clienteDiv" style="display: none;">
                <select name="cliente_id" class="form-select">
                    <option value="">Selecione o cliente</option>
                    {% for cliente in clientes %}
                        <option value="{{ cliente.id }}"> {{cliente.nome}} </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Valor Pago (apenas se for dinheiro) -->
            <div class="col-md-4 mb-3" id="valorPagoDiv" style="display: none;">
                <input type="number" step="0.01" name="pago" class="form-control" placeholder="Valor pago (opcional)">
            </div>

            <!-- Botão Finalizar -->
            <div class="col-md-4">
                <button type="submit" class="btn btn-success w-100">Finalizar Venda</button>
            </div>
        </div>
    </form>

    <!-- Script para mostrar campos condicionais -->
    <script>
        const selectPagamento = document.getElementById("pagamentoSelect");
        const divCliente = document.getElementById("clienteDiv");
        const divValorPago = document.getElementById("valorPagoDiv");

        function atualizarCampos() {
            const forma = selectPagamento.value;

            // Esconde todos primeiro
            divCliente.style.display = 'none';
            divValorPago.style.display = 'none';

            // Mostra os certos
            if (forma === 'dinheiro') {
                divValorPago.style.display = 'block';
            } else if (forma === 'fiado') {
                divCliente.style.display = 'block';
            }
            // Cartão não precisa de ação adicional
        }

        // Roda ao carregar
        window.addEventListener("DOMContentLoaded", atualizarCampos);

        // Roda ao mudar a forma de pagamento
        selectPagamento.addEventListener("change", atualizarCampos);
    </script>

{% else %}
    <div class="alert alert-info">Seu carrinho está vazio.</div>
{% endif %}
{% endblock %}